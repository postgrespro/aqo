/*
 * Check fix for CVE-2020-14350.
 * See also 7eeb1d986 postgresql commit.
 */

SET client_min_messages = 'warning';
DROP ROLE IF EXISTS regress_hacker;
SET client_min_messages = 'notice';

CREATE ROLE regress_hacker LOGIN;

-- Test 1
RESET ROLE;
ALTER ROLE regress_hacker NOSUPERUSER;
GRANT CREATE ON SCHEMA public TO regress_hacker;

SET ROLE regress_hacker;
SHOW is_superuser;
CREATE FUNCTION format(f text, r regclass, t text)
RETURNS text
AS $$
BEGIN
  ALTER ROLE regress_hacker SUPERUSER;
  RETURN '';
END
$$ LANGUAGE plpgsql RETURNS NULL ON NULL INPUT;

RESET ROLE;
CREATE EXTENSION aqo;
SET aqo.join_threshold = 0;

-- Test result (must be 'off')
SET ROLE regress_hacker;
SHOW is_superuser;

RESET ROLE;
DROP FUNCTION format(text, regclass, text);
DROP EXTENSION IF EXISTS aqo;

-- Test 2
RESET ROLE;
ALTER ROLE regress_hacker NOSUPERUSER;

SET ROLE regress_hacker;
SHOW is_superuser;

CREATE FUNCTION aqo_status(hash bigint)
RETURNS TABLE (
  "learn"       BOOL,
  "use aqo"     BOOL,
  "auto tune"   BOOL,
  "fspace hash" bigINT,
  "t_naqo"      TEXT,
  "err_naqo"    TEXT,
  "iters"       BIGINT,
  "t_aqo"       TEXT,
  "err_aqo"     TEXT,
  "iters_aqo"   BIGINT
)
AS $$
BEGIN
END
$$ LANGUAGE plpgsql;

RESET ROLE;
-- Test result (error expected)
CREATE EXTENSION aqo;

SET ROLE regress_hacker;
CREATE OR REPLACE FUNCTION aqo_status(hash bigint)
RETURNS TABLE (
  "learn"       BOOL,
  "use aqo"     BOOL,
  "auto tune"   BOOL,
  "fspace hash" bigINT,
  "t_naqo"      TEXT,
  "err_naqo"    TEXT,
  "iters"       BIGINT,
  "t_aqo"       TEXT,
  "err_aqo"     TEXT,
  "iters_aqo"   BIGINT
)
AS $$
BEGIN
  ALTER ROLE regress_hacker SUPERUSER;
END
$$ LANGUAGE plpgsql;

RESET ROLE;
SELECT aqo_status(42);

SET ROLE regress_hacker;
SHOW is_superuser;

RESET ROLE;
DROP FUNCTION aqo_status(bigint);
DROP EXTENSION IF EXISTS aqo;

-- Test 3
RESET ROLE;
ALTER ROLE regress_hacker NOSUPERUSER;

SET ROLE regress_hacker;
SHOW is_superuser;

CREATE FUNCTION aqo_enable_class(hash bigint)
RETURNS VOID
AS $$
BEGIN
END
$$ LANGUAGE plpgsql;

RESET ROLE;
-- Test result (error expected)
CREATE EXTENSION aqo;

SET ROLE regress_hacker;
CREATE OR REPLACE FUNCTION aqo_enable_class(hash bigint)
RETURNS VOID
AS $$
BEGIN
  ALTER ROLE regress_hacker SUPERUSER;
END
$$ LANGUAGE plpgsql;

RESET ROLE;
SELECT aqo_enable_class(42);

SET ROLE regress_hacker;
SHOW is_superuser;

RESET ROLE;
DROP FUNCTION aqo_enable_class(bigint);
DROP EXTENSION IF EXISTS aqo;

-- Test 4
RESET ROLE;
ALTER ROLE regress_hacker NOSUPERUSER;

SET ROLE regress_hacker;
SHOW is_superuser;

CREATE FUNCTION aqo_disable_class(hash bigint)
RETURNS VOID
AS $$
BEGIN
END
$$ LANGUAGE plpgsql;

RESET ROLE;
-- Test result (error expected)
CREATE EXTENSION aqo;

SET ROLE regress_hacker;
CREATE OR REPLACE FUNCTION aqo_disable_class(hash bigint)
RETURNS VOID
AS $$
BEGIN
  ALTER ROLE regress_hacker SUPERUSER;
END
$$ LANGUAGE plpgsql;

RESET ROLE;
SELECT aqo_disable_class(42);

SET ROLE regress_hacker;
SHOW is_superuser;

RESET ROLE;
DROP FUNCTION aqo_disable_class(bigint);
DROP EXTENSION IF EXISTS aqo;

-- Test 5
RESET ROLE;
ALTER ROLE regress_hacker NOSUPERUSER;

SET ROLE regress_hacker;
SHOW is_superuser;

CREATE FUNCTION aqo_clear_hist(hash bigint)
RETURNS VOID
AS $$
BEGIN
END
$$ LANGUAGE plpgsql;

RESET ROLE;
-- Test result (error expected)
CREATE EXTENSION aqo;

SET ROLE regress_hacker;
CREATE OR REPLACE FUNCTION aqo_clear_hist(hash bigint)
RETURNS VOID
AS $$
BEGIN
  ALTER ROLE regress_hacker SUPERUSER;
END
$$ LANGUAGE plpgsql;

RESET ROLE;
SELECT aqo_clear_hist(42);

SET ROLE regress_hacker;
SHOW is_superuser;

RESET ROLE;
DROP FUNCTION aqo_clear_hist(bigint);
DROP EXTENSION IF EXISTS aqo;

-- Test 6
RESET ROLE;
ALTER ROLE regress_hacker NOSUPERUSER;

SET ROLE regress_hacker;
SHOW is_superuser;

CREATE FUNCTION aqo_drop(hash bigint)
RETURNS VOID
AS $$
BEGIN
END
$$ LANGUAGE plpgsql;

RESET ROLE;
-- Test result (error expected)
CREATE EXTENSION aqo;

SET ROLE regress_hacker;
CREATE OR REPLACE FUNCTION aqo_drop(hash bigint)
RETURNS VOID
AS $$
BEGIN
  ALTER ROLE regress_hacker SUPERUSER;
END
$$ LANGUAGE plpgsql;

RESET ROLE;
SELECT aqo_drop(42);

SET ROLE regress_hacker;
SHOW is_superuser;

RESET ROLE;
DROP FUNCTION aqo_drop(bigint);
DROP EXTENSION IF EXISTS aqo;

-- Test 7
RESET ROLE;
ALTER ROLE regress_hacker NOSUPERUSER;

SET ROLE regress_hacker;
SHOW is_superuser;

CREATE FUNCTION aqo_ne_queries()
RETURNS SETOF int
AS $$
BEGIN
END
$$ LANGUAGE plpgsql;

RESET ROLE;
-- Test result (error expected)
CREATE EXTENSION aqo;

SET ROLE regress_hacker;
CREATE OR REPLACE FUNCTION aqo_ne_queries()
RETURNS SETOF int
AS $$
BEGIN
  ALTER ROLE regress_hacker SUPERUSER;
END
$$ LANGUAGE plpgsql;

RESET ROLE;
SELECT aqo_ne_queries();

SET ROLE regress_hacker;
SHOW is_superuser;

RESET ROLE;
DROP FUNCTION aqo_ne_queries();
DROP EXTENSION IF EXISTS aqo;

-- Test 8
RESET ROLE;
ALTER ROLE regress_hacker NOSUPERUSER;

SET ROLE regress_hacker;
SHOW is_superuser;

CREATE FUNCTION aqo_migrate_to_1_1_get_pk(rel text)
RETURNS regclass
AS $$
DECLARE
  ret regclass;
BEGIN
  ALTER ROLE regress_hacker SUPERUSER;
  SELECT * FROM aqo_migrate_to_1_1_get_pk(rel::regclass) INTO ret;
  RETURN ret;
END
$$ LANGUAGE plpgsql;

RESET ROLE;
CREATE EXTENSION aqo;

-- Test result (must be 'off')
SET ROLE regress_hacker;
SHOW is_superuser;

RESET ROLE;
DROP FUNCTION aqo_migrate_to_1_1_get_pk(text);
DROP EXTENSION IF EXISTS aqo;

-- Cleanup
RESET ROLE;
DROP OWNED BY regress_hacker CASCADE;
DROP ROLE regress_hacker;

