CREATE EXTENSION aqo;
SET aqo.mode = 'disabled';
SET aqo.force_collect_stat = 'on';
--
-- Dummy test. CREATE TABLE shouldn't find in the ML storage. But a simple
-- select must be in. Also here we test on gathering a stat on temp and plain
-- relations.
--
CREATE TEMP TABLE ttt AS SELECT count(*) AS cnt FROM generate_series(1,10);
CREATE TABLE ttp AS SELECT count(*) AS cnt FROM generate_series(1,10);
SELECT count(*) AS cnt FROM ttt WHERE cnt % 100 = 0;
 cnt 
-----
   0
(1 row)

SELECT count(*) AS cnt FROM ttp WHERE cnt % 100 = 0;
 cnt 
-----
   0
(1 row)

SELECT num FROM top_time_queries(3);
NOTICE:  Top 3 execution time queries
 num 
-----
   1
   2
(2 rows)

--
-- num of query uses table t2 should be bigger than num of query uses table t1 and be the first
--
CREATE TABLE t1 AS SELECT mod(gs,10) AS x, mod(gs+1,10) AS y
	FROM generate_series(1,1000) AS gs;
CREATE TABLE t2 AS SELECT mod(gs,10) AS x, mod(gs+1,10) AS y
	FROM generate_series(1,100000) AS gs;
SELECT count(*) FROM (SELECT x, y FROM t1 GROUP BY GROUPING SETS ((x,y), (x), (y), ())) AS q1;
 count 
-------
    31
(1 row)

SELECT count(*) FROM (SELECT x, y FROM t2 GROUP BY GROUPING SETS ((x,y), (x), (y), ())) AS q1;
 count 
-------
    31
(1 row)

SELECT num, to_char(error, '9.99EEEE') FROM show_cardinality_errors(false) AS te
WHERE te.fshash = (
  SELECT fspace_hash FROM aqo_queries
  WHERE aqo_queries.query_hash = (
    SELECT aqo_query_texts.query_hash FROM aqo_query_texts
    WHERE query_text = 'SELECT count(*) FROM (SELECT x, y FROM t2 GROUP BY GROUPING SETS ((x,y), (x), (y), ())) AS q1;'
  )
);
 num |  to_char  
-----+-----------
   1 |  1.94e+00
(1 row)

-- Should return zero
SELECT count(*) FROM show_cardinality_errors(true);
 count 
-------
     0
(1 row)

